# IP多波 multicast

![image-20220421003306838](网络层6.assets/image-20220421003306838.png)

anycast应用，对于谷歌的很多服务器，这些服务器有相同的IP地址，我只要访问到（最近的）一个就行了

![image-20220421003507310](网络层6.assets/image-20220421003507310.png)

简单地对所有的dst进行一对一传输（左图）虽然能达到目的会造成很多浪费，我们想实现的是右面这种（左面的不叫多播）

![image-20220421003650319](网络层6.assets/image-20220421003650319.png)

多播可以在多个子网中

实例：

无数电视，同时收到同一个信号，大家都在接收cctv5

视频会议，讲话者的语音发给所有的参会者

一份数据要进行多个备份，发到三个存储器上

分布式计算：初始的模型,参数，要发给所有的GPU

![image-20220421004123052](网络层6.assets/image-20220421004123052.png)

一些定义:多波组，源端(不属于多波组)，接收端

![image-20220421004453807](网络层6.assets/image-20220421004453807.png)

构造一个最小生成树，host都在叶子上，router都是非叶节点，只要路由器上有group member,那生成树要包括这个router，router收到数据包之后，根据生成树发送给下游的主机或者router

![image-20220421004837149](网络层6.assets/image-20220421004837149.png)

首先知道我管辖范围内有多少多波组，然后知道每个多波组有哪些成员，怎么到达,packet到达的时候复制n份从这n个接口发送出去

![image-20220421005217061](网络层6.assets/image-20220421005217061.png)

左图是右图的生成树

![image-20220421005525932](网络层6.assets/image-20220421005525932.png)

源端把信息发送给多波组的IP地址，源端不需要知道多波组的成员有哪些以及他们的ip地址，发给多波组，然后路由器会发下去

![image-20220421005729884](网络层6.assets/image-20220421005729884.png)

![image-20220421005944603](网络层6.assets/image-20220421005944603.png)

两个地址转换，一个是router要将组播IP地址翻译成group member 的多个ip地址

一个是组播的mac地址应该怎么创造

## 广域网的多波协议 (多个network)

![image-20220421010817355](网络层6.assets/image-20220421010817355.png)

每个host和自己network的路由器用IGMP协议沟通，告知自己加入什么group

不同network的路由器通过最小生成树交流

![image-20220421011032178](网络层6.assets/image-20220421011032178.png)

用局域网广播的方式告诉多波路由器信息

![image-20220421011252118](网络层6.assets/image-20220421011252118.png)

主机加入一个新的组，要想多波router report

如果想要退出一个组，不用发送信息，超时不响应即可

路由器要进行query，你们这个组还在吗？host进行nreply

![image-20220421011610961](网络层6.assets/image-20220421011610961.png)

![image-20220421011943132](网络层6.assets/image-20220421011943132.png)

注意看第一张图，同一个组不同host收到的timer是不一样的，因为每一个组有一个成员进行report即可，router就知道这个组还健在，设置成不同的router是为了避免让同一个host负担很多组的report，没收到report视为这个组解散了

![image-20220421012245216](网络层6.assets/image-20220421012245216.png)

第二个版本可以问特定的组还在不在，host可以静悄悄的离开，也可以大声宣布我退出这个组了

![image-20220421012627610](网络层6.assets/image-20220421012627610.png)

v1v2有点问题，会有安全问题，收到垃圾信息等等

![image-20220421012544328](网络层6.assets/image-20220421012544328.png)

只有在白名单里面的source才能像group发送

![image-20220421012840365](网络层6.assets/image-20220421012840365.png)

![image-20220421012851397](网络层6.assets/image-20220421012851397.png)

![image-20220421013049729](网络层6.assets/image-20220421013049729.png)

![image-20220421013423209](网络层6.assets/image-20220421013423209.png)

多波树的两种构建方式，固定的树，不同的源端有不同的树

![image-20220421013524041](网络层6.assets/image-20220421013524041.png)

![image-20220421013530747](网络层6.assets/image-20220421013530747.png)

最短路径树，从source到所有点的最短路径

![image-20220421013725150](网络层6.assets/image-20220421013725150.png)

![image-20220421013932777](网络层6.assets/image-20220421013932777.png)

如果是非对称路径，来回cost不一样那这个算法不太使用

![image-20220421014036334](网络层6.assets/image-20220421014036334.png)

自下向上发送剪枝信息

![image-20220421014309858](网络层6.assets/image-20220421014309858.png)

这个方法没有被广泛使用，计算复杂度太高，要知道网络所有信息，如果新加一个节点，全部都要重新算，np完全问题，只有近似解法等等有很多问题

![image-20220421014412083](网络层6.assets/image-20220421014412083.png)

![image-20220421014606581](网络层6.assets/image-20220421014606581.png)

上面说的是算法，下面说的是协议，协议是用算法实现的

![image-20220421015929094](网络层6.assets/image-20220421015929094.png)

![image-20220421015906895](网络层6.assets/image-20220421015906895.png)

PIM协议，稀疏模式，稠密模式

ip的多波协议实际上并没有得到广泛的应用，安全问题，复杂的协议，出现数据丢死没法找回等等，性能问题等等。使得使用场景非常少。

但是多波的需求是存在的，IP层的多波协议不好用，那应用层实现他怎么样

![image-20220421020935932](网络层6.assets/image-20220421020935932.png)

底层的通讯实际上是单波

![image-20220421021231686](网络层6.assets/image-20220421021231686.png)

理论上没有IP层的多波协议效率高，时间短，但是部署更容易，有很多其他的好处

要考虑怎么贴近IP层，做出更合理的end system multicast